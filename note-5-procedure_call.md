# 过程调用

## X86-Linux-32 程序栈
* 自顶向下生长
* 栈底指针为 `0xbffffxxx`
* ESP 寄存器为栈顶指针
* 栈单元大小是 32 位

## 栈帧
* 分配给一个过程使用的栈空间
* 包括：
  * 过程的局部变量、形参、返回地址、临时保存的寄存器
* 当前栈空间由一系列嵌套调用的过程的栈帧组成
* EBP 寄存器位当前栈帧基址指针

### 栈帧的结构
* 父过程栈帧：
  * 当前过程参数
  * 调用者返回地址
* 当前过程栈帧：
  * EBP（栈帧基址）旧值       <-当前栈帧基址
  * 局部变量                 <-当前栈顶
  * ...

## 过程调用指令
### CALL
* `CALL dest`：将下一条指令的地址压入栈，跳转到 `dest` 所指示的目标地址执行。
  * `CALL label`：相对地址调用，相对地址偏移量由汇编器确定
  * `CALL r/m`：绝对地址间接调用，`r/m` 指寄存器或内存地址

### RET
* `RET` / `RET src`：从栈中弹出返回地址，再退栈 `src` 字节（若有），跳到返回地址执行
  * `RET`：返回调用过程。
  * `RET imm`：返回调用过程，并退栈 `imm` 个字节。

### PUSH
* `PUSH src`：栈指针下移，将操作数 `src` 的内容压入该栈单元。
  * `PUSH imm/r/m`：`src` 可以是立即数、寄存器、内存单元
  * `PUSH cs/ss/ds/es/fs/gs`：可以是段寄存器

### POP
* `POP dest`：将栈顶单元的内容传输至 `dest`，栈指针上移。
  * `POP r/m`：`src` 可以是寄存器、内存单元
  * `POP ss/ds/es/fs/gs`：可以是段寄存器，但不能是 `cs` 段寄存器。

### LEAVE
* `LEAVE`，释放当前栈帧：把 `ebp` 寄存器的值传输给 `esp`，再从栈顶单元恢复 `ebp`的值。
* X86-Linux 环境中的 GCC 只使用 `LEAVE` 指令，不使用配套的 `ENTER` 指令

## ABI 应用程序二进制接口
### x86-Linux-32 ABI
* 参数与返回值约定：
  * 参数通过栈传递
  * 传递顺序是从右向左
  * 参数由调用者维护，属于调用者栈帧
  * 返回值存放在 `eax` 寄存器中
  * 返回地址存放在调用者的栈帧顶部
* 寄存器使用约定：
  * `eax` 保存返回值
  * 调用者保存 `eax`、`edx`、`ecx`
  * 被调用者保存 `ebx`、`esi`、`edi`
  * `ebp` 和 `esp` 是栈帧指针和栈顶指针
* 栈帧的约定：
  * 栈帧的布局：
    * `ebp` 寄存器旧值
    * 其他要保存的寄存器、局部变量
    * 形参
    * 返回地址
  * 栈帧主体以 16 字节为单位分配
  * 栈单元大小是 32 位

### x86-Linux-64 ABI
* 参数与返回值约定：
  * **前六个参数**通过寄存器传递
  * **第7个参数起**通过栈传递，传递顺序是从右向左
  * 参数由调用者维护，属于调用者栈帧
  * 返回值存放在 `rax` 寄存器中
  * 返回地址存放在调用者的栈帧顶部
* 寄存器使用约定：
  * `rax` 保存返回值
  * 被调用者保存 `rbp`、`rbx`、`r12` ～ `r15`
  * 调用者保存其他
  * `rbp` 和 `rsp` 是栈帧指针和栈顶指针
  * `rdi`、`rsi`、`rdx`、`rcx`、`r8`、`r9` 分别为第 1 至第 6 参数。
* 栈帧的约定：
  * 栈帧的布局：
    * `ebp` 寄存器旧值
    * 其他要保存的寄存器、局部变量
    * 形参
    * 返回地址
  * 栈帧主体以 16（32，64）字节对齐
  * 栈单元大小是 64 位